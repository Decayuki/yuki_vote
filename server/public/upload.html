<!DOCTYPE html>
<html>
<head>
    <title>Upload Logo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Upload Logo</h1>
        <div id="error-message" style="color: red; margin-bottom: 20px;"></div>
        <form id="uploadForm" class="upload-form">
            <div class="form-group">
                <label for="groupNumber">Numéro de Groupe:</label>
                <input type="number" id="groupNumber" name="groupNumber" required min="1">
            </div>
            <div class="form-group">
                <label for="variant">Variante:</label>
                <input type="text" id="variant" name="variant" required pattern="[A-Da-d]" title="Entrez une lettre de A à D">
            </div>
            <div class="form-group">
                <label for="logo">Logo:</label>
                <input type="file" id="logo" name="logo" accept="image/*" required>
            </div>
            <button type="submit" class="btn">Upload</button>
        </form>
        
        <div id="uploaded-logos" class="logo-grid">
            <!-- Les logos uploadés seront affichés ici -->
        </div>
    </div>

    <script>
        // Configuration de base
        const API_BASE = '';  // Vide pour les chemins relatifs
        
        // Connexion Socket.IO avec l'URL actuelle
        const socket = io(window.location.origin, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5
        });

        async function loadLogos() {
            const errorDiv = document.getElementById('error-message');
            try {
                const response = await fetch(`${API_BASE}/api/logos`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Failed to load logos: ${response.status}`);
                }
                
                const logos = await response.json();
                if (!Array.isArray(logos)) {
                    throw new Error('Invalid logos data received');
                }

                document.getElementById('uploaded-logos').innerHTML = logos.map(logo => `
                    <div class="logo-item">
                        <img src="${logo.image_url}" alt="Logo ${logo.group_number}${logo.variant}" onerror="this.src='/placeholder.png'">
                        <div class="logo-info">
                            <span>Group ${logo.group_number}</span>
                            <span>Variant ${logo.variant}</span>
                        </div>
                    </div>
                `).join('');
                
                errorDiv.textContent = '';
                console.log('Logos loaded successfully');
            } catch (error) {
                console.error('Error loading logos:', error);
                errorDiv.textContent = `Error: ${error.message}`;
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '';
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            try {
                const formData = new FormData();
                const groupNumber = document.getElementById('groupNumber').value;
                const variant = document.getElementById('variant').value.toUpperCase();
                const logoFile = document.getElementById('logo').files[0];

                if (!logoFile) {
                    throw new Error('Please select a file to upload');
                }

                if (logoFile.size > 5 * 1024 * 1024) {
                    throw new Error('File size must be less than 5MB');
                }

                console.log('Preparing upload:', { groupNumber, variant, fileName: logoFile.name });

                formData.append('groupNumber', groupNumber);
                formData.append('variant', variant);
                formData.append('logo', logoFile);

                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('Upload response:', result);

                if (!response.ok) {
                    throw new Error(result.error || 'Upload failed');
                }

                errorDiv.style.color = 'green';
                errorDiv.textContent = 'Upload successful!';
                loadLogos();
                e.target.reset();
            } catch (error) {
                console.error('Upload error:', error);
                errorDiv.style.color = 'red';
                errorDiv.textContent = `Error: ${error.message}`;
            } finally {
                submitButton.disabled = false;
            }
        });

        // Validate variant input
        document.getElementById('variant').addEventListener('input', (e) => {
            const value = e.target.value.toUpperCase();
            if (!/^[A-D]$/.test(value)) {
                e.target.setCustomValidity('Please enter a letter from A to D');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // Load existing logos on page load
        loadLogos();

        // Socket.IO event handlers
        socket.on('logoAdded', () => {
            console.log('New logo added, refreshing...');
            loadLogos();
        });

        socket.on('connect', () => {
            console.log('Socket.IO connected');
            document.getElementById('error-message').textContent = '';
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
            document.getElementById('error-message').textContent = `Connection error: ${error.message}`;
        });

        socket.on('disconnect', (reason) => {
            console.log('Socket.IO disconnected:', reason);
            if (reason === 'io server disconnect') {
                socket.connect();
            }
        });
    </script>
</body>
</html>
